<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:MedSestriManipulations.Models"
             xmlns:local="clr-namespace:MedSestriManipulations"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="MedSestriManipulations.HistoryPage"
             Title="Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ">


    <ScrollView>
        <VerticalStackLayout Padding="10" Spacing="12">
            <Label Text="Ð¢ÑŠÑ€ÑÐ¸ Ð¿Ð¾:" FontAttributes="Bold" FontSize="14" TextColor="DarkGray" />

            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="8" x:Name="SearchGrid">

                <toolkit:Expander x:Name="ExpanderName" Grid.Column="0" Grid.ColumnSpan="1" IsExpanded="{Binding IsNameExpanded, Mode=TwoWay}">
                    <toolkit:Expander.Header>
                        <Button Text="ðŸ” Ð˜Ð¼Ðµ" />
                    </toolkit:Expander.Header>
                    <SearchBar Placeholder="Ð¢ÑŠÑ€ÑÐ¸ Ð¿Ð¾ Ð¸Ð¼Ðµ..." FontSize="16" TextChanged="OnSearchByNameChanged" />
                </toolkit:Expander>

                <toolkit:Expander x:Name="ExpanderEGN" Grid.Column="1" Grid.ColumnSpan="1" 
                  IsExpanded="{Binding IsEGNExpanded, Mode=TwoWay}">
                    <toolkit:Expander.Header>
                        <Button Text="ðŸ§¾ Ð•Ð“Ð" />
                    </toolkit:Expander.Header>
                    <SearchBar Placeholder="Ð¢ÑŠÑ€ÑÐ¸ Ð¿Ð¾ Ð•Ð“Ð..." FontSize="16" TextChanged="OnSearchByEGNChanged"/>
                </toolkit:Expander>

                <toolkit:Expander x:Name="ExpanderPhone" Grid.Column="2" Grid.ColumnSpan="1" 
                  IsExpanded="{Binding IsPhoneExpanded, Mode=TwoWay}">
                    <toolkit:Expander.Header>
                        <Button Text="ðŸ“± Ð¢ÐµÐ»." />
                    </toolkit:Expander.Header>
                    <SearchBar Placeholder="Ð¢ÑŠÑ€ÑÐ¸ Ð¿Ð¾ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½..." FontSize="16" TextChanged="OnSearchByPhoneChanged"/>
                </toolkit:Expander>

            </Grid>


            <CollectionView x:Name="HistoryList" SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:RequestHistoryEntry">
                        <Border Stroke="LightGray"
            StrokeThickness="1"
            StrokeShape="RoundRectangle 12"
            Padding="10">

                            <VerticalStackLayout>
                                <!-- Ð—Ð°Ð³Ð»Ð°Ð²Ð¸Ðµ, ÐºÐ»Ð¸ÐºÐ²Ð°ÐµÐ¼Ð¾ -->
                                <Label Text="{Binding Name}"
                   FontAttributes="Bold"
                   FontSize="16"
                   TextColor="DarkBlue">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type local:HistoryPage}}, Path=BindingContext.ToggleCommand}"
                                          CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>

                                <!-- ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚Ð¸ â€” Ð²Ð¸Ð´Ð¸Ð¼Ð¸ ÑÐ°Ð¼Ð¾ Ð°ÐºÐ¾ IsExpanded Ðµ true -->
                                <StackLayout x:Name="DetailsSection"
                         IsVisible="{Binding IsExpanded}"
                         ClassId="DetailsSection">

                                    <Label Text="{Binding Date, StringFormat='Ð”Ð°Ñ‚Ð°: {0:dd.MM.yyyy HH:mm}'}" />
                                    <Label Text="{Binding Note}" />

                                    <Button Text="ðŸ—‘ Ð˜Ð·Ñ‚Ñ€Ð¸Ð¹"
                        FontSize="12"
                        BackgroundColor="Red"
                        TextColor="White"
                        Margin="0,10,0,0"
                        Command="{Binding Source={RelativeSource AncestorType={x:Type local:HistoryPage}}, Path=BindingContext.RemoveCommand}"
                        CommandParameter="{Binding .}" />

                                    <Button Text="ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð°Ð¹"
                        FontSize="10"
                        BackgroundColor="LightGray"
                        TextColor="Black"
                        Command="{Binding Source={RelativeSource AncestorType={x:Type local:HistoryPage}}, Path=BindingContext.CopyCommand}"
                        CommandParameter="{Binding .}" />

                                </StackLayout>
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>

                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
