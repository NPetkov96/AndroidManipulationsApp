<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="MedSestriManipulations.MainPage"
             BackgroundColor="#F2F4F7">

    <ScrollView>
        <VerticalStackLayout Padding="5" Spacing="15">

            <!-- Бутоните -->
            <HorizontalStackLayout HorizontalOptions="Center" Spacing="15">
                <Button Text="Изпрати" Clicked="OnSendClicked" BackgroundColor="#007BFF" TextColor="White" CornerRadius="10" Padding="15,10" />
                <Button Text="Зачисти" Clicked="OnClearClicked" BackgroundColor="DarkRed" TextColor="White" CornerRadius="10" Padding="15,10"/>
            </HorizontalStackLayout>

            <!-- Полета за данни -->
            <Label Text="Данни за пациент:" FontSize="22" FontAttributes="Bold"/>
            <Entry x:Name="CurrentName" Placeholder="Име" FontSize="20" BackgroundColor="White" TextChanged="AutoCompleteText"/>
            <ListView x:Name="NameSuggestionsListView" ItemsSource="{Binding NameSuggestions}" ItemTapped="AutoCompleteSuggestionTapped" IsVisible="False" HeightRequest="140" BackgroundColor="White" RowHeight="35">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <TextCell Text="{Binding}"/>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <Entry x:Name="EGNEntry" Placeholder="ЕГН" Keyboard="Numeric" FontSize="20" BackgroundColor="White" TextChanged="AutoCompleteText"/>
            <ListView x:Name="EGNSuggestionsListView" ItemsSource="{Binding EGNSuggestions}" ItemTapped="AutoCompleteSuggestionTapped" IsVisible="False" HeightRequest="140" BackgroundColor="White" RowHeight="35">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <TextCell Text="{Binding}"/>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>

            <Entry x:Name="PhoneEntry" Placeholder="Телефон" Keyboard="Telephone" FontSize="20" BackgroundColor="White" TextChanged="AutoCompleteText"/>
            <ListView x:Name="PhoneSuggestionsListView" ItemsSource="{Binding PhoneSuggestions}" ItemTapped="AutoCompleteSuggestionTapped" IsVisible="False" HeightRequest="140" BackgroundColor="White" RowHeight="35">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <TextCell Text="{Binding}"/>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
            
            <Entry x:Name="UIN" Placeholder="Лекар УИН" Keyboard="Numeric" FontSize="20" BackgroundColor="White"/>

            <!-- Изследвания -->
            <Grid ColumnDefinitions="Auto, *" HeightRequest="50" Padding="10,0">
                <Label Text="Изследвания:" FontSize="18" FontAttributes="Bold" VerticalOptions="Center" HorizontalOptions="Start" Grid.Column="0"/>
                <!-- Общо -->
                <Label x:Name="TotalLabel" Text="0.00 лв" FontSize="18" FontAttributes="Bold" TextColor="#007BFF" VerticalOptions="Center" HorizontalOptions="Center" Grid.Column="1"/>
            </Grid>
            <Grid ColumnDefinitions="*, Auto" HeightRequest="50">
                <SearchBar x:Name="SearchBar" Placeholder="Търси изследване..." TextChanged="OnSearchTextChanged" BackgroundColor="White"/>
            </Grid>


            <!-- Списък с процедури -->
            <CollectionView x:Name="ProcedureList" ItemsSource="{Binding Procedures}" HeightRequest="500" Margin="0,0,0,10" RemainingItemsThreshold="5" RemainingItemsThresholdReached="OnLoadMore">
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border Margin="0,5" StrokeShape="RoundRectangle 12" BackgroundColor="White">
                            <StackLayout Orientation="Horizontal" VerticalOptions="Center">
                                <CheckBox IsChecked="{Binding IsSelected}" CheckedChanged="OnProcedureCheckedChanged" Color="#007BFF" Scale="1.4" VerticalOptions="Center"/>

                                <StackLayout Margin="10,0" VerticalOptions="Center">
                                    <StackLayout.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="ShowMoreInfoForProcedure" />
                                    </StackLayout.GestureRecognizers>

                                    <Label Text="{Binding Name}" FontSize="18" TextColor="Black" />
                                    <Label Text="{Binding Price, StringFormat=' {0:F2} лв'}" FontSize="16" TextColor="Gray" Margin="0,2,0,0"/>
                                </StackLayout>
                            </StackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
